pipeline {
    agent any

    options {
        timestamps()
    }

    parameters {
        booleanParam(
            name: 'FORCE_DEPLOY',
            defaultValue: false,
            description: 'Force deployment even if no changes detected'
        )
    }

    environment {
        GCP_SA_KEY = "abc"
    }

    stages {

        stage('Init') {
            steps {
                script {
                    echo "Branch name: ${env.BRANCH_NAME}"
                    echo "Commit: ${env.GIT_COMMIT}"

                    env.IMAGE_TAG = "${env.BUILD_NUMBER}-${env.GIT_COMMIT.take(7)}"

                    if (env.BRANCH_NAME in ['prod', 'main']) {
                        env.ENV_FILE   = 'Jenkins/prod.env'
                        env.TARGET_ENV = 'PROD'
                    } else if (env.BRANCH_NAME in ['dev', 'uat']) {
                        env.ENV_FILE   = 'Jenkins/dev.env'
                        env.TARGET_ENV = 'DEV'
                    } else {
                        error("‚ùå Unsupported branch: ${env.BRANCH_NAME}")
                    }

                    echo "Target environment: ${env.TARGET_ENV}"
                    echo "Using env file: ${env.ENV_FILE}"
                }
            }
        }

        stage('Detect & Deploy') {
            steps {
                script {
                    if (!fileExists(env.ENV_FILE)) {
                        error("‚ùå ${env.ENV_FILE} not found in repo")
                    }

                    /* ============================================================
                    LOAD ENV FILE INTO MAP
                    ============================================================ */
                    def envMap = [:]

                    readFile(env.ENV_FILE).split('\n').each { line ->
                        line = line.trim()
                        if (!line || line.startsWith('#')) return

                        def (k, v) = line.split('=', 2)
                        envMap[k] = v
                    }

                    /* ============================================================
                    EXPORT ENV VARS (SAFE)
                    ============================================================ */
                    withEnv(envMap.collect { k, v -> "${k}=${v}" }) {

                        /* ============================================================
                        FIND DEPLOYMENTS
                        ============================================================ */
                        def deployments = []

                        envMap.keySet().each { k ->
                            if (k.startsWith('DEPLOY_') && k.endsWith('_PATH')) {
                                deployments << k
                                    .replace('DEPLOY_', '')
                                    .replace('_PATH', '')
                            }
                        }

                        if (deployments.isEmpty()) {
                            echo "‚ö†Ô∏è No deployments defined"
                            return
                        }

                        /* ============================================================
                        PROCESS EACH DEPLOYMENT
                        ============================================================ */
                        deployments.each { name ->
                            def path = env["DEPLOY_${name}_PATH"]
                            def type = env["DEPLOY_${name}_TYPE"]

                            if (!path || !type) {
                                error("‚ùå Missing DEPLOY_${name}_PATH or DEPLOY_${name}_TYPE")
                            }

                            echo "üîç Checking changes for ${name}"

                            def changedFiles = sh(
                                script: "git diff HEAD~1 HEAD --name-only | grep '^${path}' || true",
                                returnStdout: true
                            ).trim()

                            if (!changedFiles && !params.FORCE_DEPLOY) {
                                echo "‚è≠Ô∏è No changes for ${name}"
                                return
                            }

                            /* ============================================================
                            DEPLOY: GCS (ONLY CHANGED FILES)
                            ============================================================ */
                            if (type == 'GCS') {
                                def bucket = env["DEPLOY_${name}_GCS_BUCKET"]
                                def prefix = env["DEPLOY_${name}_GCS_PREFIX"]

                                if (!bucket || !prefix) {
                                    error("‚ùå Missing GCS config for ${name}")
                                }

                                echo "ü™£ Deploying changed files to GCS for ${name}"

                                changedFiles.split('\n').each { file ->
                                    echo """
                                        gsutil cp ${file} gs://${bucket}/${prefix}/${file.replaceFirst("^${path}/?", "")}
                                    """
                                    // change to sh here
                                }
                            }

                            /* ============================================================
                            DEPLOY: CLOUD RUN
                            ============================================================ */
                            else if (type == 'CLOUDRUN') {
                                echo "‚òÅÔ∏è Deploying ${name} to Cloud Run"
                                // deployToCloudRun(name) -- Uncomment this
                            }

                            else {
                                error("‚ùå Unknown DEPLOY type for ${name}")
                            }
                        }
                    }
                }
            }
        }

    }

    post {
        success {
            echo "üéâ Deployment successful for ${env.TARGET_ENV}"
        }
        failure {
            echo "‚ùå Deployment failed"
        }
        always {
            script {
                if (env.WORKSPACE) {
                    cleanWs()
                }
            }
        }
    }
}
