pipeline {
    agent any

    parameters {
        booleanParam(
            name: 'FORCE_DEPLOY',
            defaultValue: false,
            description: 'Force deployment even if no changes detected'
        )
    }

    environment {
        IMAGE_TAG = "${BUILD_NUMBER}-${GIT_COMMIT.take(7)}"
        GCP_SA_KEY = credentials('gcp-service-account-key')
    }

    stages {

        /* ============================================================
           INIT + ENV FILE SELECTION
        ============================================================ */
        stage('Checkout & Init') {
            steps {
                script {
                    checkout scm

                    def branch = env.GIT_BRANCH ?: 'unknown'
                    echo "Branch detected: ${branch}"

                    if (branch.contains('prod') || branch.contains('main')) {
                        env.ENV_FILE = 'prod.env'
                        env.TARGET_ENV = 'PROD'
                    } else if (branch.contains('dev') || branch.contains('uat')) {
                        env.ENV_FILE = 'dev.env'
                        env.TARGET_ENV = 'DEV'
                    } else {
                        error("‚ùå Unsupported branch for deployment")
                    }

                    echo "Target env: ${env.TARGET_ENV}"
                    echo "Using env file: ${env.ENV_FILE}"
                }
            }
        }

        /* ============================================================
           LOAD ENV FILE
        ============================================================ */
        stage('Load Environment Config') {
            steps {
                script {
                    if (!fileExists(env.ENV_FILE)) {
                        error("‚ùå ${env.ENV_FILE} not found")
                    }

                    readFile(env.ENV_FILE).split('\n').each { line ->
                        line = line.trim()
                        if (!line || line.startsWith('#')) return
                        def (k, v) = line.split('=', 2)
                        env[k] = v
                    }

                    echo "‚úÖ Environment variables loaded"
                }
            }
        }

        /* ============================================================
           GCP AUTH
        ============================================================ */
        // stage('GCP Auth') {
        //     steps {
        //         sh """
        //             gcloud auth activate-service-account --key-file=${GCP_SA_KEY}
        //             gcloud config set project ${PROJECT_ID}
        //         """
        //     }
        // }

        /* ============================================================
           DETECT CHANGED DEPLOYMENTS
        ============================================================ */
        stage('Detect Changes') {
            steps {
                script {
                    def deployments = []

                    env.each { k, v ->
                        if (k.startsWith('DEPLOY_') && k.endsWith('_PATH')) {
                            def name = k.replace('DEPLOY_', '').replace('_PATH', '')
                            deployments << name
                        }
                    }

                    def changed = []

                    deployments.each { name ->
                        def path = env["DEPLOY_${name}_PATH"]

                        def diff = sh(
                            script: "git diff HEAD~1 HEAD --name-only | grep '^${path}' || true",
                            returnStdout: true
                        ).trim()

                        if (diff || params.FORCE_DEPLOY) {
                            changed << name
                        }
                    }

                    if (changed.isEmpty()) {
                        echo "‚ö†Ô∏è No changes detected"
                        env.SKIP_DEPLOY = 'true'
                    } else {
                        env.CHANGED_DEPLOYS = changed.join(',')
                        echo "Deploying components: ${env.CHANGED_DEPLOYS}"
                    }
                }
            }
        }

        /* ============================================================
           DEPLOY
        ============================================================ */
        // stage('Deploy') {
        //     when {
        //         expression { env.SKIP_DEPLOY != 'true' }
        //     }
        //     steps {
        //         script {
        //             env.CHANGED_DEPLOYS.split(',').each { name ->
        //                 def type = env["DEPLOY_${name}_TYPE"]

        //                 if (type == 'GCS') {
        //                     deployToGCS(name)
        //                 } else if (type == 'CLOUDRUN') {
        //                     deployToCloudRun(name)
        //                 } else {
        //                     error("‚ùå Unknown DEPLOY type for ${name}")
        //                 }
        //             }
        //         }
        //     }
        // }
    }

    post {
        success {
            echo "üéâ Deployment successful for ${env.TARGET_ENV}"
        }
        failure {
            echo "‚ùå Deployment failed"
        }
        always {
            cleanWs()
        }
    }
}

/* ============================================================
   FUNCTIONS
============================================================ */

def deployToGCS(name) {
    def path   = env["DEPLOY_${name}_PATH"]
    def bucket = env["DEPLOY_${name}_GCS_BUCKET"]
    def prefix = env["DEPLOY_${name}_GCS_PREFIX"]

    echo "ü™£ Deploying ${name} to GCS"

    sh """
        gsutil -m rsync -r -d ${path} gs://${bucket}/${prefix}/
    """
}

def deployToCloudRun(name) {
    def path    = env["DEPLOY_${name}_PATH"]
    def image   = env["DEPLOY_${name}_IMAGE"]
    def service = env["DEPLOY_${name}_SERVICE"]

    echo "‚òÅÔ∏è Deploying ${name} to Cloud Run"

    sh """
        cd ${path}
        docker build -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REPO}/${image}:${IMAGE_TAG} .
        docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REPO}/${image}:${IMAGE_TAG}

        gcloud run deploy ${service} \
            --image=${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REPO}/${image}:${IMAGE_TAG} \
            --region=${REGION} \
            --platform=managed \
            --allow-unauthenticated
    """
}
